<% content_for(:html_head) do %>
  <% javascript_tag do %>
    jQuery(function($){
      $('#blocks tbody tr').hover(function(){
        $(this).addClass('hover')
      }, function(){
        $(this).removeClass('hover')
      }).click(function(){
        var match = this.id.match(/(.*)_(\d+)/) 
        var type = match[1]
        var id = match[2]
        $('#blocks tbody tr').removeClass('selected')
        $(this).addClass('selected')
        $('#view_button').removeClass('disabled').attr('href', '/cms/blocks/'+type+'/show/'+id)
        $('#edit_button').removeClass('disabled').attr('href', '/cms/blocks/'+type+'/edit/'+id)
        $('#delete_button').removeClass('disabled').attr('href', '/cms/blocks/'+type+'/delete/'+id)        
      })
    })
  <% end %>
<% end %>
<% @page_title = "Content Library / List #{@content_type.display_name_plural}" %>

<% form_tag '', :method => :get do -%>
  Search
  <%= text_field_tag :search, params[:search] %>
  <% if @content_type.name == "HtmlBlock" -%>
    <p><%= check_box_tag :include_body, true, params[:include_body] %> Include body?</p>
  <% end -%>
  <% if %w[FileBlock ImageBlock].include?(@content_type.name) %>
    <p><%= select_tag 'section_id', searchable_sections(params[:section_id]) %></p>
  <% end -%>
  <%= submit_tag "Search" %>
<% end -%>

<table id="blocks">
  <thead>
    <tr>
      <% if @blocks.first.respond_to?(:name) %><th>Name</th><% end %>
      <% @content_type.columns_for_index.each do |column| %>
        <th><%= column[:label] %></th>
      <% end %>
      <th>Updated</th>
      <% if @blocks.first.respond_to?(:connected_pages) %><th>Used</th><% end %>
      <% if @blocks.first.respond_to?(:status) %><th>Status</th><% end %>
    </tr>
  </thead>
  <tbody>
    <% @blocks.each do |block| %>
      <tr id="<%= block.class.name.underscore %>_<%= block.id %>">
        <% if @blocks.first.respond_to?(:name) %><td class="block_name"><%= block.name %></td><% end %>
        <% @content_type.columns_for_index.each do |column| %>
          <td><%= block.send(column[:method]) %></td>      
        <% end %>
        <td><%= block.updated_at.to_s(:date) %></td>
        <% if @blocks.first.respond_to?(:connected_pages) %><td class="used"><%= link_to_usages(block) %></td><% end %>
        <% if @blocks.first.respond_to?(:status) %><td class="block_status"><%=  status_icon(block.status) %></td><% end %>
      </tr>
    <% end %>
  </tbody>
</table>